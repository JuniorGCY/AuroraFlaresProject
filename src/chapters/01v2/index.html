<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aurora Flares — Capítulo 1</title>
  <style>
    html,body{
      margin:0;height:100%;background:#000;color:#e5e7eb;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",sans-serif;
      overflow:hidden
    }

    /* Vídeo de fundo (abaixo do Spline) */
    #bgVideoWrap{
      position:fixed;inset:0;z-index:0;pointer-events:none;
      background:#000;opacity:0;transition:opacity .5s ease
    }
    #bgVideoWrap.show{opacity:1}
    #bgVideo{
      width:100%;height:100%; /* tela cheia de fato */
      object-fit:cover;display:block;background:#000
    }

    /* Spline por cima até “Decolar” */
    #wrap{position:fixed;inset:0;z-index:10;transition:opacity .45s ease}
    #wrap.fade{opacity:0}
    canvas{position:absolute;inset:0;width:100%;height:100%;display:block;border:0}

    /* HUD e botão */
    #hud{
      position:fixed;right:10px;top:10px;z-index:40;
      background:rgba(0,0,0,.55);border:1px solid #334155;border-radius:10px;
      padding:6px 9px;font:12px/1.3 system-ui;max-width:60ch;white-space:pre-wrap
    }
    #decolarBtn{
      position:fixed;left:50%;bottom:32px;transform:translateX(-50%);
      z-index:50;border:1px solid #334155;border-radius:999px;padding:12px 20px;
      background:linear-gradient(180deg,#111827,#0b1220);color:#e5e7eb;
      font-weight:600;letter-spacing:.2px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.35);
      transition:transform .12s ease,filter .2s ease,opacity .2s ease;
      display:inline-flex;align-items:center;gap:8px;pointer-events:auto
    }
    #decolarBtn:hover{transform:translateX(-50%) scale(1.02);filter:brightness(1.06)}
    #decolarBtn:active{transform:translateX(-50%) scale(.98)}
    #decolarBtn[disabled]{opacity:.6;cursor:default}
    #decolarBtn svg{width:18px;height:18px;display:block}
  </style>
</head>
<body>
  <!-- Vídeo -->
  <div id="bgVideoWrap" aria-hidden="true">
    <video id="bgVideo" preload="auto" muted playsinline aria-hidden="true">
      <!-- Ajuste o caminho conforme seu projeto (MP4 H.264/AAC garante compatibilidade) -->
      <source src="../../../assets/videos/takeoff.mp4" type="video/mp4">
    </video>
  </div>

  <!-- Spline (top) -->
  <div id="wrap" aria-label="Cena Spline">
    <canvas id="splineCanvas"></canvas>
    <div id="hud">Carregando…</div>
    <button id="decolarBtn" type="button" aria-label="Entrar no site">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M5 15c-1.657 0-3 1.343-3 3 0 .552.448 1 1 1 .552 0 1-.448 1-1 0-.552.448-1 1-1 .552 0 1-.448 1-1s-.448-1-1-1Zm6.586-6.586a2 2 0 0 1 2.828 0l1.172 1.172a2 2 0 0 1 0 2.828l-6.95 6.95a2 2 0 0 1-1.414.586H6a1 1 0 0 1-1-1v-1.222a2 2 0 0 1 .586-1.414l6.95-6.95Z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M14 4.5c2.9 0 5.5.7 7.5 2.5-1.8 2-2.5 4.6-2.5 7.5M9.5 10C9.5 7.1 10.2 4.5 12 2.5"/>
      </svg>
      Decolar
    </button>
  </div>

  <script type="module">
    (async () => {
      /************ CONFIG ************/
      const SCENE_URL = 'https://prod.spline.design/Jh4IVFWdQkMNXXgy/scene.splinecode';
      const GAME_URL  = '../01v3/index.html'; // destino após o VÍDEO terminar

      const hud = document.getElementById('hud');
      const wrap = document.getElementById('wrap');
      const btn  = document.getElementById('decolarBtn');

      const bgWrap  = document.getElementById('bgVideoWrap');
      const bgVideo = document.getElementById('bgVideo');

      const log = (m)=>{ hud.textContent = String(m); console.log('[app]', m); };

      /************ SPLINE ************/
      let app;
      try {
        const { Application } = await import('https://unpkg.com/@splinetool/runtime@1.9.36/build/runtime.js');
        const canvas = document.getElementById('splineCanvas');

        function resizeCanvasToDisplaySize(c){
          const dpr = Math.min(window.devicePixelRatio || 1, 2);
          const w = Math.floor(c.clientWidth  * dpr);
          const h = Math.floor(c.clientHeight * dpr);
          if (c.width !== w || c.height !== h) { c.width = w; c.height = h; }
        }
        function fit(){ resizeCanvasToDisplaySize(canvas); try{ app?.resize?.(); }catch{} }
        new ResizeObserver(fit).observe(canvas);
        window.addEventListener('resize', fit);

        app = new Application(canvas);
        const bust = SCENE_URL + (SCENE_URL.includes('?')?'&':'?') + '_cb=' + Date.now();
        log('Baixando cena do Spline…');
        await app.load(bust);
        fit();
        log('Cena carregada. Clique em “Decolar”.');
      } catch (err) {
        console.error('Erro carregando Spline:', err);
        log('Falha ao carregar Spline. Você ainda pode clicar em “Decolar”.');
      }

      /************ VÍDEO ************/
      async function startBackgroundVideo(){
        // Mostrar o contêiner (fade-in)
        bgWrap.classList.add('show');

        // iOS/Android exigem gesto do usuário para iniciar; já temos o clique do botão
        if (bgVideo.readyState < 2) {
          await new Promise(res => {
            const ok = () => { bgVideo.removeEventListener('loadeddata', ok); res(); };
            bgVideo.addEventListener('loadeddata', ok, { once:true });
          });
        }

        // Recomeça do início e inicia reprodução
        bgVideo.currentTime = 0;

        // Para garantir autoplay no mobile, começa MUTED no clique…
        bgVideo.muted = true;
        bgVideo.playsInline = true;
        bgVideo.setAttribute('playsinline', '');
        bgVideo.setAttribute('webkit-playsinline', '');

        await bgVideo.play();
        log('Vídeo reproduzindo.');

        // …e, como houve gesto do usuário, liberamos o áudio logo após começar
        // (alguns navegadores pedem um "tick" assíncrono)
        queueMicrotask(()=>{ try { bgVideo.muted = false; } catch {} });
      }

      function fadeOutSpline(){
        wrap.classList.add('fade');
        // dá um tempo para o fade terminar e libera memória do runtime
        setTimeout(()=>{ try{ app?.dispose?.(); }catch{}; wrap.style.display='none'; }, 480);
      }

      // Clique do botão: começa o VÍDEO e só depois some o Spline
      btn.addEventListener('click', async ()=>{
        btn.disabled = true; // evita múltiplos cliques
        try { await startBackgroundVideo(); }
        finally { fadeOutSpline(); }
      });

      // Enter também “decola”
      document.addEventListener('keydown', (ev)=>{ if (ev.key === 'Enter') btn.click(); });

      /************ REDIRECT APÓS O VÍDEO ************/
      let redirected = false;
      const goToGame = () => {
        if (redirected) return;
        redirected = true;
        window.location.href = GAME_URL;
      };

      // Caminho normal: quando o vídeo termina
      bgVideo.addEventListener('ended', goToGame);

      // Fallback: se por algum bug o 'ended' não disparar, ao chegar ~97% do vídeo, segue.
      bgVideo.addEventListener('timeupdate', ()=>{
        if (!redirected && bgVideo.duration && bgVideo.currentTime / bgVideo.duration > 0.97) {
          goToGame();
        }
      });

      // Fallback duro de segurança (opcional): nunca travar a turma
      setTimeout(()=>{ if (!redirected) goToGame(); }, 120000); // 2 min
    })();
  </script>
</body>
</html>
